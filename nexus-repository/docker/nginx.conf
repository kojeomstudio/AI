user  nginx;
worker_processes  auto;

events { worker_connections  1024; }

http {
  include       /etc/nginx/mime.types;
  sendfile      on;
  keepalive_timeout  65;
  server_tokens off;

  # 업스트림: Nexus UI
  upstream nexus_ui {
    server nexus:8081;
  }

  # 업스트림: Nexus Docker repo 커넥터(예: 8082)
  upstream nexus_docker {
    server nexus:8082;
  }

  # HTTP → HTTPS 리다이렉트
  server {
    listen 80;
    server_name ${SERVER_NAME};
    return 301 https://$host$request_uri;
  }

  # HTTPS 서버
  server {
    listen 443 ssl;
    http2   on;
    server_name ${SERVER_NAME};

    # 인증서(예시: self-signed 또는 실제 인증서)
    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    # Nexus UI 프록시 (루트)
    location / {
      proxy_pass http://nexus_ui;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # Docker Registry v2 엔드포인트
    location /v2/ {
      proxy_pass http://nexus_docker;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;

      # 대용량 업로드/다운로드 대비
      client_max_body_size 0;
      chunked_transfer_encoding on;
    }
  }
}
